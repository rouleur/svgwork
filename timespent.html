<!DOCTYPE html>
<html>
<head>
    <style>
        .trail-pie-chart path {
            stroke-opacity: 0;
            transition: fill-opacity 250ms linear, stroke-width 250ms linear, stroke-opacity 250ms linear;
            -moz-transition: fill-opacity 250ms linear, stroke-width 250ms linear, stroke-opacity 250ms linear;
            -webkit-transition: fill-opacity 250ms linear, stroke-width 250ms linear, stroke-opacity 250ms linear;
        }

        .trail-pie-chart .pie-chart-slice text {
            dy: 1.70em;
            text-anchor: middle;
            color: #333333;
            background-color: #ffffff
        }

        .trail-pie-chart path {
            stroke: #fff;
            stroke-width: 1px;
            stroke-opacity: 1;
        }

        .trail-pie-chart .hover path {
            fill-opacity: .1;
        }
    </style>
</head>
<body bgcolor="gray">
<div id="graph"></div>
</body>
<script src="/Users/gokhangorali/workspace/smtrail/trail-frontend/dist/static/lib/d3/d3.v3.min.js"
        charset="utf-8"></script>
<script type="text/javascript">
    var histogramData = {
        "entityName": "Sneha Bhawsinka",
        "histogram": [
            {
                "addressPart": "Sector 19, Noida",
                "hitCount": 10
            },
            {
                "addressPart": "Subroto Park Extension, Subroto Park",
                "hitCount": 1
            },
            {
                "addressPart": "Block Y, Hauz Khas",
                "hitCount": 1
            },
            {
                "addressPart": "Sport View, Delhi Cantonment",
                "hitCount": 43
            },
            {
                "addressPart": "Lajpat Nagar II, Lajpat Nagar",
                "hitCount": 1
            },
            {
                "addressPart": "Sector 9, Noida",
                "hitCount": 3
            },
            {
                "addressPart": "Sector 15, Noida",
                "hitCount": 1
            },
            {
                "addressPart": "Mehram Nagar East, Mehram Nagar",
                "hitCount": 5
            },
            {
                "addressPart": "Sector 4, Noida",
                "hitCount": 133
            },
            {
                "addressPart": "Sector 20, Noida",
                "hitCount": 15
            },
            {
                "addressPart": "Sector 3, Noida",
                "hitCount": 28
            },
            {
                "addressPart": "Sector 27, Noida",
                "hitCount": 73
            },
            {
                "addressPart": "Sector 5, Noida",
                "hitCount": 3
            }
        ]
    };

    function labelPositionAccordingToPieAngle(arc, d) {
        var c = arc.centroid(d);
        var diffAngle = Math.abs(d.startAngle - d.endAngle);
        var factor = (2 * Math.PI - diffAngle) / 3;
        c[0] = c[0] * factor;
        c[1] = c[1] * factor;
        return c;
    }

    function addEntityNameLabel(svg, height, histogramData) {
        svg.append("text")
                .attr("transform", "translate(" + 0 + ",-" + (height / 2) + ")")
                .attr("dy", ".35em")
                .style("font-size", "15px")
                .style("text-anchor", "middle")
                .text(histogramData.entityName);
    }

    function addAddressLabels(svg, arc, treshhold) {
        svg.selectAll(".pie-chart-slice").append("text")
                .attr("transform", function (d) {
                    return "translate(" + labelPositionAccordingToPieAngle(arc, d) + ")";
                })
                .attr("dy", ".35em")
                .style("text-anchor", function (d) {
                    return "middle";
                })
                .text(function (d) {
                    if (d.data.hitCount > treshhold) {
                        var firstPart = d.data.addressPart.split(',')[0];
                        if (firstPart.indexOf('Near ') == -1) return firstPart;
                    }
                });
        svg.selectAll(".pie-chart-slice").append("text")
                .attr("transform", function (d) {
                    return "translate(" + labelPositionAccordingToPieAngle(arc, d) + ")";
                }).attr("dy", "1.70em")
                .text(function (d) {
                    if (d.data.hitCount > treshhold) {
                        return d.data.addressPart.split(',')[1];

                    }
                });
    }

    function addAddressLabels2(svg, arc, pos) {
        pos.append("text")
                .attr("transform", function (d) {
                    return "translate(" + labelPositionAccordingToPieAngle(arc, d) + ")";
                })
                .attr("dy", ".35em")
                .style("text-anchor", function (d) {
                    return "middle";
                })
                .text(function (d) {

                    var firstPart = d.data.addressPart.split(',')[0];
                    if (firstPart.indexOf('Near ') == -1) return firstPart;

                });
        pos.append("text")
                .attr("transform", function (d) {
                    return "translate(" + labelPositionAccordingToPieAngle(arc, d) + ")";
                }).attr("dy", "1.70em")
                .text(function (d) {
                    return d.data.addressPart.split(',')[1];
                });
    }

    function drawPieColorized(svg, pie, histogramData, arc, color) {
        var g = svg.selectAll(".pie-chart-slice")
                .data(pie(histogramData.histogram))
                .enter().append("g")
                .attr("class", "pie-chart-slice").on("mouseover", function () {
                    d3.select(this).attr("class", "pie-chart-slice hover");
                    addAddressLabels2(svg, arc, d3.select(this));
                }).on("mouseout", function () {
                    d3.select(this).attr("class", "pie-chart-slice");
                });

        g.append("path")
                .attr("d", arc)
                .style("fill", function (d) {
                    return color(d.data.addressPart);
                });
        return g;
    }

    function drawPieChartForHistogram(histogramData, treshhold, graphDivName) {
        var width = 350,
                height = 350,
                radius = 150;

        var color = d3.scale.ordinal()
                .range(["#f1595f", "#79c36a", "#599ad3", "#f9a65a", "#9e66ab", "#cd7058", "#d77fb3"]);

        var arc = d3.svg.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

        var pie = d3.layout.pie()
                .sort(null)
                .value(function (d) {
                    return d.hitCount;
                });

        var svg = d3.select("#graph").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")")
                .attr("class", "trail-pie-chart");

        drawPieColorized(svg, pie, histogramData, arc, color);
        // addAddressLabels(svg, arc, treshhold);
        addEntityNameLabel(svg, height, histogramData);
    }


    drawPieChartForHistogram(histogramData, 10, "graph");

</script>
</html>